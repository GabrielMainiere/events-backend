@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/refs/heads/master/C4_Component.puml
AddRelTag("port", $lineStyle=DashedLine())

title Diagrama de Componentes - MS Notifications (Arquitetura Hexagonal)

Container_Boundary(msnotifications, "MS Notifications - Hexagonal Architecture") {
    
    ' ------------ CAMADA EXTERNA - ADAPTERS INPUT ------------
    Boundary(adaptersInput, "Adapters Input (Drivers)") {
        Component(graphqlAdapter, "GraphQL Adapter", "NestJS Resolver", "API GraphQL para gerenciar templates e preferências")
        Component(rabbitConsumer, "RabbitMQ Consumer", "NestJS Controller", "Consome eventos de notificação (notification.dispatch)")
    }
    
    ' ------------ CAMADA MÉDIA - APPLICATION ------------
    Boundary(application, "Application Layer") {
        Component(processNotificationUseCase, "Process Notification Use Case", "Use Case", "Processa notificação recebida")
        Component(createTemplateUseCase, "Create Template Use Case", "Use Case", "Cria novo template")
        Component(updateTemplateUseCase, "Update Template Use Case", "Use Case", "Atualiza template existente")
        Component(upsertPreferenceUseCase, "Upsert Preference Use Case", "Use Case", "Gerencia preferências de usuário")
        
        Component(notificationMapper, "Notification Mapper", "Mapper", "Domain ↔ DTO")
        Component(templateMapper, "Template Mapper", "Mapper", "Domain ↔ DTO")
    }
    
    ' ------------ CAMADA INTERNA - DOMAIN ------------
    Boundary(domain, "Domain Layer (Core)") {
        Component(notificationAggregate, "Notification Aggregate", "Aggregate Root", "Entidade raiz que gerencia o ciclo de vida")
        Component(templateEntity, "Template Entity", "Entity", "Entidade de template")
        Component(preferenceEntity, "Preference Entity", "Entity", "Preferências de notificação do usuário")
        
        Component(emailVO, "Email Value Object", "Value Object", "Validação de email")
        Component(notificationFactory, "Notification Factory", "Factory Pattern", "Cria notificações válidas")
        
        Component(notificationProcessor, "Notification Processor", "Domain Service", "Orquestra processamento de notificação")
        Component(templateRenderer, "Template Renderer", "Domain Service", "Renderiza templates (Handlebars)")
        Component(permissionService, "Permission Service", "Domain Service", "Valida preferências do usuário")
        
        ' Ports (Interfaces)
        Component(notificationRepoPort, "Notification Repository Port", "Interface (Port OUT)", "Contrato de persistência")
        Component(templateRepoPort, "Template Repository Port", "Interface (Port OUT)", "Contrato de templates")
        Component(preferenceRepoPort, "Preference Repository Port", "Interface (Port OUT)", "Contrato de preferências")
        Component(notificationSenderPort, "Notification Sender Port", "Interface (Port OUT)", "Contrato de envio")
    }
    
    ' ------------ CAMADA EXTERNA - ADAPTERS OUTPUT ------------
    Boundary(adaptersOutput, "Adapters Output (Driven)") {
        Component(notificationRepoImpl, "Notification Repository", "Prisma Adapter", "Implementa NotificationRepositoryPort")
        Component(templateRepoImpl, "Template Repository", "Prisma Adapter", "Implementa TemplateRepositoryPort")
        Component(preferenceRepoImpl, "Preference Repository", "Prisma Adapter", "Implementa PreferenceRepositoryPort")
        
        Component(strategyFactory, "Strategy Factory", "Factory Pattern", "Cria estratégia de envio com decorators")
        Component(emailStrategy, "Email Strategy", "Strategy Pattern", "Implementação de envio por email")
        Component(auditDecorator, "Audit Decorator", "Decorator Pattern", "Log de auditoria")
        Component(retryDecorator, "Retry Decorator", "Decorator Pattern", "Retry automático")
        Component(performanceDecorator, "Performance Decorator", "Decorator Pattern", "Medição de performance")
        
        Component(smtpAdapter, "SMTP Adapter", "Nodemailer", "Cliente SMTP")
        Component(prismaSingleton, "Prisma Singleton", "Singleton Pattern", "Instância única do Prisma")
    }
}

ComponentDb(database, "Notifications DB", "PostgreSQL", "Armazena notificações, templates e preferências")
ContainerQueue(rabbitmq, "RabbitMQ", "Message Broker", "Exchange: notifications_exchange, Queue: notifications.dispatch")
Component_Ext(smtpServer, "SMTP Server", "Servidor de email externo")

' ------------ RELACIONAMENTOS ------------

' Input Adapters -> Use Cases
Rel(graphqlAdapter, createTemplateUseCase, "Chama", "HTTP")
Rel(graphqlAdapter, updateTemplateUseCase, "Chama", "HTTP")
Rel(graphqlAdapter, upsertPreferenceUseCase, "Chama", "HTTP")
Rel(rabbitConsumer, processNotificationUseCase, "Chama", "Event")

' RabbitMQ -> Input Adapter
Rel_U(rabbitmq, rabbitConsumer, "Consome eventos", "AMQP")

' Use Cases -> Domain Services
Rel(processNotificationUseCase, notificationProcessor, "Usa")
Rel(processNotificationUseCase, notificationMapper, "Usa")
Rel(createTemplateUseCase, templateMapper, "Usa")

' Domain Services -> Entities/VOs
Rel(notificationProcessor, notificationAggregate, "Cria/Manipula")
Rel(notificationProcessor, notificationFactory, "Usa")
Rel(notificationProcessor, templateRenderer, "Usa")
Rel(notificationProcessor, permissionService, "Valida")
Rel(notificationFactory, emailVO, "Valida")

' Domain Services -> Ports (Interfaces)
Rel(notificationProcessor, notificationRepoPort, "Usa", $tags="port")
Rel(notificationProcessor, templateRepoPort, "Usa", $tags="port")
Rel(notificationProcessor, preferenceRepoPort, "Usa", $tags="port")
Rel(notificationProcessor, notificationSenderPort, "Usa", $tags="port")

' Ports -> Output Adapters (Dependency Injection)
Rel(notificationRepoPort, notificationRepoImpl, "Implementado por", $tags="port")
Rel(templateRepoPort, templateRepoImpl, "Implementado por", $tags="port")
Rel(preferenceRepoPort, preferenceRepoImpl, "Implementado por", $tags="port")
Rel(notificationSenderPort, strategyFactory, "Implementado por", $tags="port")

' Strategy Pattern + Decorators
Rel(strategyFactory, emailStrategy, "Cria e injeta")
Rel(strategyFactory, auditDecorator, "Envolve (wrap)")
Rel(strategyFactory, retryDecorator, "Envolve (wrap)")
Rel(strategyFactory, performanceDecorator, "Envolve (wrap)")
Rel(emailStrategy, smtpAdapter, "Usa")

' Adapters -> Infraestrutura
Rel(notificationRepoImpl, prismaSingleton, "Usa")
Rel(templateRepoImpl, prismaSingleton, "Usa")
Rel(preferenceRepoImpl, prismaSingleton, "Usa")
Rel(prismaSingleton, database, "Lê/Grava", "SQL")
Rel(smtpAdapter, smtpServer, "Envia email", "SMTP")

SHOW_LEGEND()
@enduml
@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/refs/heads/master/C4_Component.puml

title Diagrama de Componentes - MS Notifications

Container_Boundary(msnotifications, "MS Notifications") {
    
    Component(grpcController, "gRPC Controller", "NestJS Controller", "Recebe requisições gRPC (Ex: Enviar Notificação)")
    Component(graphqlResolver, "GraphQL Resolver", "NestJS Resolver", "Expõe API GraphQL (Ex: Gerenciar Templates)")
    
    Component(notificationService, "Notification Service", "Service", "Orquestra a lógica de 'enfileirar' a notificação")
    
    Component(notificationWorker, "Notification Worker", "@nestjs/schedule (Cron)", "Verifica o banco de dados por envios pendentes a cada 10s")
    Component(batchProcessor, "Batch Processor", "Service", "Processa os envios pendentes em lote")
    Component(notificationSender, "Notification Sender", "Service", "Coordena o envio de uma única notificação")
    Component(templateProcessor, "Template Processor", "Handlebars", "Processa templates com dados dinâmicos")

    Component(strategyFactory, "Strategy Factory", "Factory Pattern", "Monta a pilha de estratégia + decorators")
    Component(emailStrategy, "Email Strategy", "Strategy Pattern", "Implementação concreta de envio de email")
    Component(auditDecorator, "Audit Decorator", "Decorator Pattern", "Adiciona log de auditoria")
    Component(retryDecorator, "Retry Decorator", "Decorator Pattern", "Adiciona lógica de retry")
    Component(performanceDecorator, "Performance Decorator", "Decorator Pattern", "Adiciona log de performance")
    
    Component(notificationRepo, "Notification Repository", "Repository", "Lê e grava logs de notificações")
    Component(templateRepo, "Template Repository", "Repository", "Gerencia templates")
    Component(preferenceRepo, "Preference Repository", "Repository", "Gerencia preferências de usuário")
    
    Component(prismaSingleton, "Prisma Singleton", "Singleton Pattern", "Gerencia a instância única do PrismaClient")
    
    Component(emailClient, "Email Client", "Nodemailer", "Cliente SMTP para envio")
}

ComponentDb(database, "Notifications DB", "PostgreSQL", "Armazena logs, templates e preferências. Atua como fila (tabela NotificationLog).")
Component_Ext(smtpServer, "SMTP Server", "Servidor de email")

Rel(graphqlResolver, templateRepo, "Gerencia")
Rel(graphqlResolver, preferenceRepo, "Gerencia")

Rel(grpcController, notificationService, "Chama")
Rel(notificationService, preferenceRepo, "Lê")
Rel(notificationService, notificationRepo, "Enfileira (Grava PENDENTE)")

Rel(notificationWorker, notificationRepo, "Consome (Lê PENDENTE)")
Rel(notificationWorker, batchProcessor, "Dispara")
Rel(batchProcessor, notificationSender, "Delega")
Rel(batchProcessor, notificationRepo, "Atualiza Status")

Rel(notificationSender, templateProcessor, "Usa")
Rel(notificationSender, strategyFactory, "Usa")
Rel(strategyFactory, emailStrategy, "Injeta")
Rel(strategyFactory, auditDecorator, "Cria (wrap)")
Rel(strategyFactory, retryDecorator, "Cria (wrap)")
Rel(strategyFactory, performanceDecorator, "Cria (wrap)")
Rel(notificationSender, emailStrategy, "Chama 'send()'")
Rel(emailStrategy, emailClient, "Usa")
Rel(emailClient, smtpServer, "Envia", "SMTP")

Rel(notificationRepo, prismaSingleton, "Usa", "getInstance()")
Rel(templateRepo, prismaSingleton, "Usa", "getInstance()")
Rel(preferenceRepo, prismaSingleton, "Usa", "getInstance()")

Rel(prismaSingleton, database, "Lê/Grava", "Prisma")

SHOW_LEGEND()
@enduml
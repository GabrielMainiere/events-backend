@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/refs/heads/master/C4_Container.puml
AddRelTag("async", $lineStyle=DashedLine())
AddRelTag("sync", $lineStyle=SolidLine())

title Diagrama de Containers - Sistema de Gerenciamento de Eventos (RabbitMQ + Hexagonal)

Person(user, "Usuário", "Participante ou organizador")
System_Ext(mercadoPago, "Mercado Pago API", "Gateway de pagamento")
System_Ext(stripe, "Stripe API", "Gateway de pagamento")
System_Ext(smtpServer, "Servidor SMTP", "Envio de emails (Ex: Gmail)")
System_Ext(currencyApi, "External Currency API", "API de Cotação de Moedas")

System_Boundary(eventsSystem, "Sistema de Gerenciamento de Eventos (Docker Compose)") {

    Container(gateway, "Kong API Gateway", "Kong", "Ponto único de entrada, autenticação JWT, roteamento")

    Container(msusers, "MS Users", "NestJS/TypeScript", "Gerencia usuários e autenticação (GraphQL + gRPC + RabbitMQ Producer)")
    Container(msevents, "MS Events", "NestJS/TypeScript (Hexagonal)", "Gerencia eventos (GraphQL + RabbitMQ Publisher)")
    Container(msregistration, "MS Events Registration", "NestJS/TypeScript", "Gerencia inscrições (GraphQL + gRPC + RabbitMQ Consumer)")
    Container(mspayments, "MS Payments", "Java/Spring Boot", "Processa pagamentos (GraphQL + gRPC Server + Client)")
    Container(msnotifications, "MS Notifications", "NestJS/TypeScript (Hexagonal)", "Gerencia notificações (GraphQL + RabbitMQ Consumer)")
    Container(mscurrency, "MS Currency", "Java/Spring Boot (Hexagonal)", "Gerencia e atualiza cotações de moedas")
    
    ContainerQueue(rabbitmq, "RabbitMQ", "Message Broker", "Mensageria assíncrona, filas e exchanges")
    
    ContainerDb(dbUsers, "Users DB", "PostgreSQL", "Dados de usuários e roles")
    ContainerDb(dbEvents, "Events DB", "PostgreSQL", "Dados de eventos")
    ContainerDb(dbRegistration, "Registration DB", "PostgreSQL", "Inscrições, cache de eventos/usuários")
    ContainerDb(dbPayments, "Payments DB", "PostgreSQL", "Dados de pagamentos")
    ContainerDb(dbNotifications, "Notifications DB", "PostgreSQL", "Logs, templates e fila de envio")
    ContainerDb(dbCurrency, "Currency DB", "PostgreSQL", "Armazena preços de moedas (BRL)")
}

Rel_U(user, gateway, "Requisições", "HTTPS")

Rel_D(gateway, msusers, "/msusers", "HTTP", $tags="sync")
Rel_D(gateway, msevents, "/msevents", "HTTP", $tags="sync")
Rel_D(gateway, msregistration, "/mseventsregistration", "HTTP", $tags="sync")
Rel_D(gateway, mspayments, "/mspayments", "HTTP", $tags="sync")
Rel_D(gateway, msnotifications, "/msnotifications", "HTTP", $tags="sync")
Rel_D(gateway, mscurrency, "/mscurrency", "HTTP", $tags="sync")

Rel_D(msusers, dbUsers, "Lê/Grava", "Prisma")
Rel_D(msevents, dbEvents, "Lê/Grava", "Prisma")
Rel_D(msregistration, dbRegistration, "Lê/Grava", "Prisma")
Rel_D(mspayments, dbPayments, "Lê/Grava", "JPA")
Rel_D(msnotifications, dbNotifications, "Lê/Grava (Polling)", "Prisma")
Rel_D(mscurrency, dbCurrency, "Lê/Grava", "JPA")

Rel_R(msregistration, msusers, "Valida Usuário", "gRPC", $tags="sync")
Rel_R(msevents, msregistration, "Conta Inscrições", "gRPC", $tags="sync")
Rel_R(mspayments, msregistration, "Busca Inscrição", "gRPC", $tags="sync")

Rel_D(msusers, rabbitmq, "Publica evento", "RabbitMQ", $tags="async")
Rel_D(msregistration, rabbitmq, "Publica evento", "RabbitMQ", $tags="async")
Rel_D(msevents, rabbitmq, "Publica evento", "RabbitMQ", $tags="async")
Rel_D(mscurrency, rabbitmq, "Publica cotação", "RabbitMQ", $tags="async")

Rel_D(rabbitmq, msnotifications, "Consome eventos", "RabbitMQ", $tags="async")
Rel_D(rabbitmq, mspayments, "Consome eventos", "RabbitMQ", $tags="async")
Rel_D(rabbitmq, msregistration, "Consome eventos", "RabbitMQ", $tags="async")

Rel_R(msnotifications, smtpServer, "Envia Email", "SMTP")
Rel_R(mspayments, mercadoPago, "Processa Pagamento", "REST API")
Rel_R(mspayments, stripe, "Processa Pagamento", "REST API")
Rel_R(mscurrency, currencyApi, "Busca Cotações", "REST API")
Rel_U(mercadoPago, mspayments, "Webhook", "HTTPS")
Rel_U(stripe, mspayments, "Webhook", "HTTPS")

SHOW_LEGEND()
@enduml
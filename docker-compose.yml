name: "events-backend"
services:
  mspayments:
    container_name: mspayments
    build: /mspayments
    env_file:
      - /mspayments/.env
    depends_on:
      - mspayments-postgres
    networks:
      - mspayments
      - events-backend
  mspayments-postgres:
    container_name: mspayments-postgres
    image: postgres:17.4-alpine
    ports:
      - "5433:5433"
    volumes:
      - ./.data/postgresql/data:/var/lib/postgresql
    env_file:
      - /mspayments/.env
    command: -p 5433
    networks:
      - mspayments
  
  msnotifications:
    container_name: msnotifications
    build:
      context: ./msnotifications
      dockerfile: Dockerfile
    env_file:
      - ./msnotifications/.env.docker
    depends_on:
      msnotifications-postgres:
        condition: service_healthy
    networks:
      - msnotifications
      - events-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  msnotifications-postgres:
    container_name: msnotifications-postgres
    image: postgres:17.2-alpine
    ports:
      - "5434:5432"
    env_file:
      - ./msnotifications/.env.docker
    volumes:
      - msnotifications-data:/var/lib/postgresql/data
    networks:
      - msnotifications
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-msnotifications}"]
      interval: 10s
      timeout: 5s
      retries: 5
  msevents-postgres:
    container_name: msevents-postgres
    image: postgres:17.2-alpine
    ports:
      - "5435:5432"
    env_file:
      - ./msevents/.env.docker
    volumes:
      - msevents-data:/var/lib/postgresql/data
    networks:
      - msevents
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-msevents}"]
      interval: 10s
      timeout: 5s
      retries: 5
  msevents:
    container_name: msevents
    build:
      context: ./msevents
      dockerfile: Dockerfile
    env_file:
      - ./msevents/.env.docker
    depends_on:
      msevents-postgres:
        condition: service_healthy
    networks:
      - msevents
      - events-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  mseventsregistration-postgres:
    container_name: mseventsregistration-postgres
    image: postgres:17.2-alpine
    ports:
      - "5436:5432"
    env_file:
      - ./mseventsregistration/.env.docker
    volumes:
      - mseventsregistration-data:/var/lib/postgresql/data
    networks:
      - mseventsregistration
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-mseventsregistration}"]
      interval: 10s
      timeout: 5s
      retries: 5
  mseventsregistration:
    container_name: mseventsregistration
    build:
      context: ./mseventsregistration
      dockerfile: Dockerfile
    env_file:
      - ./mseventsregistration/.env.docker
    depends_on:
      mseventsregistration-postgres:
        condition: service_healthy
    networks:
      - mseventsregistration
      - events-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  msusers-postgres:
    container_name: msusers-postgres
    image: postgres:17.2-alpine
    ports:
      - "5437:5432"
    env_file:
      - ./msusers/.env.docker
    volumes:
      - msusers-data:/var/lib/postgresql/data
    networks:
      - msusers
    restart: unless-stopped

  msusers:
    container_name: msusers
    build:
      context: ./msusers
      dockerfile: Dockerfile
    env_file:
      - ./msusers/.env.docker
    depends_on:
      - msusers-postgres
    networks:
      - msusers
      - events-backend
    restart: unless-stopped

  kong:
    build: ./gateway
    container_name: kong
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/declarative/kong.yml
      KONG_PROXY_LISTEN: '0.0.0.0:8000'
      KONG_ADMIN_LISTEN: '0.0.0.0:8001'
      KONG_ANONYMOUS_REPORTS: 'off'
      KONG_PLUGINS: 'bundled,jwt-claims-injector'
    volumes:
      - ./.env:/tmp/.env:ro
    networks:
      - events-backend
    ports:
      - "8000:8000"
      - "8001:8001"

volumes:
  msnotifications-data:
    driver: local
  msevents-data:
    driver: local
  mseventsregistration-data:
    driver: local
  msusers-data:
    driver: local
    
networks:
  events-backend:
    driver: bridge
  mspayments:
    driver: bridge
  msnotifications:
    driver: bridge
  msevents:
    driver: bridge
  mseventsregistration:
    driver: bridge
  msusers:
    driver: bridge